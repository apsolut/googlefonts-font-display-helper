<!DOCTYPE html>
<html>
  <!-- The code of the tool is pretty shitty – I was composing it quickly. Please don’t judge.
       This shittiness doesn’t affect the snippet generated by the tool. -->
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Make your Google Fonts render faster · PerfPerfPerf</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Ubuntu, 'Helvetica Neue', sans-serif;
        background: #eee;
      }

      h1,
      h2 {
        font-family: 'Merriweather', Georgia, serif;
      }

      h1 {
        margin-top: 0;
      }

      h2 {
        margin-top: 2em;
      }

      a {
        color: #06c;
        text-decoration: none;
        border-bottom: 1px solid;
        border-color: rgba(0, 102, 204, 0.25);
        transition: color 0.25s ease-out, border-color 0.25s ease-out;
      }

      a:hover,
      a:focus,
      a:active {
        color: #d04000;
        border-color: rgba(208, 64, 0, 0.25);
        transition: none;
      }

      code {
        font-family: 'Fira Code', 'Fira Mono', monospace;
        font-size: 0.9em;
      }

      button {
        display: inline-block;
        color: white;
        border-width: initial;
        border-style: none;
        border-color: initial;
        border-image: initial;
        border-radius: 2px;
        padding: 6px 18px;
        background: black;
        transition: transform 0.2s ease-out 0s;
        margin-bottom: 6px;
        cursor: pointer;
      }

      button:hover,
      button:focus,
      button:active {
        background: #333;
      }

      input,
      textarea {
        border: thin solid black;
        border-radius: 2px;
        padding: 4px;
      }

      p {
        margin: 1em 0;
      }

      ol {
        padding: 0;
        list-style-position: inside;
      }

      ol li {
        margin: 1em 0;
      }

      img {
        max-width: 100%;
      }

      video {
        max-width: 100%;
      }

      footer {
        margin-top: 30px;
        font-size: 13px;
      }

      #source-code {
        font-family: 'Fira Code', 'Fira Mono', monospace;
        width: 100%;
        margin-top: 0.5em;
      }

      #result-block {
        margin-top: 0.5em;
      }

      #result {
        font-family: 'Fira Code', 'Fira Mono', monospace;
        width: 100%;
        min-height: 200px;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 24px 18px;
      }

      .logo-link {
        display: block;
        border: none;
        margin-bottom: 36px;
      }

      .logo {
        display: block;
        width: 50px;
        height: 50px;
      }
    </style>
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css?family=Fira+Mono|Merriweather:700"
      as="fetch"
      crossorigin="anonymous"
    />
    <script type="text/javascript">
      (function() {
        var fontStylesheet =
          'https://fonts.googleapis.com/css?family=Fira+Mono|Merriweather:700';
        var fontDisplayValue = 'swap';
        var cssLocalStorageKey = '__3perf_googleFontsStylesheet';

        function insertFallback() {
          var link = document.createElement('link');
          link.href = fontStylesheet;
          link.rel = 'stylesheet';
          (document.head || document.body).appendChild(link);
        }

        function patchAndInsertStylesheet(stylesheet) {
          var stylesheetWithFontDisplay = stylesheet.replace(
            /@font-face {/g,
            '@font-face {\n  font-display: ' + fontDisplayValue + ';'
          );

          var style = document.createElement('style');
          style.innerHTML = stylesheetWithFontDisplay;
          (document.head || document.body).appendChild(style);
        }

        var isFontDisplaySupported =
          window.FontFace &&
          window.FontFace.prototype.hasOwnProperty('display');
        if (!isFontDisplaySupported) {
          insertFallback();
          return;
        }

        if (localStorage.getItem(cssLocalStorageKey)) {
          var stylesheet = localStorage.getItem(cssLocalStorageKey);
          patchAndInsertStylesheet(stylesheet);
          // Still initiate fetch() to avoid “Unused <link rel="preload">” warnings
          fetch(fontStylesheet).then(() => {});
          return;
        }

        fetch(fontStylesheet)
          .then(function(response) {
            return response.text();
          })
          .then(function(stylesheet) {
            localStorage.setItem(cssLocalStorageKey, stylesheet);
            return stylesheet;
          })
          .then(patchAndInsertStylesheet)
          .catch(insertFallback);
      })();
    </script>
  </head>
  <body>
    <div class="container">
      <!-- <div class="cover">
        <img class="cover__image" src="/cover-3.png" />
      </div> -->
      <a href="https://3perf.com" class="logo-link">
        <img src="/3perf-logo-black.svg" alt="PerfPerfPerf logo" class="logo"
      /></a>
      <h1>Make your Google Fonts render faster</h1>

      <ol>
        <li>
          Select the fonts you need
          <a href="https://fonts.google.com">on Google Fonts</a>.
        </li>
        <li>
          Copy a link to the Google Fonts stylesheet – or just the code they
          provide – and paste it below:
          <input
            id="source-code"
            value="https://fonts.googleapis.com/css?family=Fira+Mono|Montserrat"
          />
        </li>
        <li>
          Copy the resulting code and insert it into your
          <code>&lt;head></code> tag – instead of the Google Fonts snippet:
          <div id="result-block">
            <button id="copy-button">Copy</button><br />
            <textarea id="result" readonly></textarea>
          </div>
        </li>
      </ol>

      <h2>What is this?</h2>
      <p>
        When you use a custom font (like a font from Google Fonts),
        <a
          href="https://developers.google.com/web/updates/2016/02/font-display#differences_in_font_rendering_today"
          >most modern browsers</a
        >
        won’t render the text immediately. Instead, they will keep the text
        hidden until the font is downloaded – or until 3 seconds pass. If a user
        opens a page with such font from a slow connection (e.g. from mobile),
        it will look like this:
      </p>
      <p>
        <video autoplay muted>
          <source src="/loading-video.mp4" type="video/mp4" />
          <source src="/loading-video.webm" type="video/webm" />
          Your browser doesn't support HTML5 video. Here is a
          <a href="/loading-video.mp4">link to the video</a> instead.
        </video>
      </p>
      <p>
        This hurts user experience –
        <a href="https://3perf.com/talks/web-perf-101/#perf-importance-header"
          >and affects business metrics</a
        >.
      </p>
      <p>
        In 2017-2018, most browsers released support for
        <a
          href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display"
          ><code>font-display</code></a
        >, a CSS feature that helps to configure that behavior. For example,
        with <code>font-display: swap</code>, the text is rendered immediately
        using a fallback font. Then, when a custom font is downloaded, the text
        is re-rendered in that font.
      </p>
      <p>
        Unfortunately, Google Fonts
        <a href="https://github.com/google/fonts/issues/358"
          >don’t support <code>font-display</code> natively</a
        >, so you can’t apply this optimization to them. This tool generates a
        small wrapper around Google Fonts that adds
        <code>font-display</code> support and helps to render text quicker.
      </p>
      <h2>How does this work?</h2>
      <p>
        The tool generates a snippet of code that:
      </p>
      <ul>
        <li>downloads the Google Fonts stylesheet asynchronously,</li>
        <li>patches it to insert the <code>font-display</code> declaration,</li>
        <li>and inserts that stylesheet into the document.</li>
      </ul>
      <p>
        The snippet should work fine in older browsers. It uses
        <a
          href="https://github.com/bramstein/fontfaceobserver/issues/62#issuecomment-398399886"
          >the <code>window.FontFace</code> check</a
        >
        to detect if a browser supports <code>font-display</code>. If the
        browser doesn’t support <code>font-display</code>, or if
        <code>window.FontFace</code> is not available, the script falls back to
        inserting a regular <code>&lt;link> tag</code>.
      </p>
      <p>
        The snippet doesn’t cause unnecessary font jumps. If the Google Fonts
        stylesheet is already cached, the script will insert it into the
        document synchronously – so that the browser can apply custom fonts
        immediately.
      </p>
      <h2>How does the tool affect performance?</h2>
      <p>
        The tool tries to be as lightweight as possible. To achieve performance
        similar to the original <code>&lt;link rel="stylesheet"></code>, the
        tool:
      </p>
      <ul>
        <li>
          generates a <code>&lt;link rel="preload"></code> tag so the browser
          starts downloading the stylesheet as soon as possible,
        </li>
        <li>
          and provides an inline script instead of an external one – to avoid
          making an extra HTTP request
        </li>
      </ul>
      <p>
        Because the tool uses <code>&lt;link rel="preload" as="fetch"></code> –
        and not <code>&lt;link rel="preload" as="style"></code> – in Chrome, the
        stylesheet’s priority will be one level lower, and it might start
        downloading slightly later. However, overall, the performance effect
        should be positive, because the Google Fonts stylesheet won’t block page
        rendering anymore, and fonts will display immediately.
      </p>
      <footer>
        With 🖤, <a href="https://twitter.com/iamakulov">Ivan Akulov</a> for
        <a href="https://3perf.com">PerfPerfPerf</a><br />© 2019. License:
        <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA</a>
        for the content,
        <a href="https://opensource.org/licenses/MIT">MIT</a> for the generated
        code
      </footer>
      <script>
        const getSnippet = fontFamily => {
          const snippet = `
<!-- Code snippet for speeding up Google Fonts rendering: googlefonts.3perf.com -->
<link rel="preload" href="$FONT_FAMILY$" as="fetch" crossorigin="anonymous" />
<script type="text/javascript">
  !function(){var t="$FONT_FAMILY$",n="__3perf_googleFontsStylesheet";function e(){var e=document.createElement("link");e.href=t,e.rel="stylesheet",(document.head||document.body).appendChild(e)}function o(e){var t=e.replace(/@font-face {/g,"@font-face { font-display: $FONT_DISPLAY$;"),n=document.createElement("style");n.innerHTML=t,(document.head||document.body).appendChild(n)}if(window.FontFace&&window.FontFace.prototype.hasOwnProperty("display")){if(localStorage.getItem(n))return o(localStorage.getItem(n)),fetch(t);fetch(t).then(function(e){return e.text()}).then(function(e){return localStorage.setItem(n,e),e}).then(o).catch(e)}else e()}()
<\/script>
<!-- End of the code snippet -->
          `.trim();

          return snippet
            .replace(/\$FONT_FAMILY\$/g, fontFamily)
            .replace(/\$FONT_DISPLAY\$/g, 'swap');
        };

        const setResultTextarea = value => {
          document.querySelector('#result').value = value;
        };

        const updateResult = () => {
          const sourceCode = document.querySelector('#source-code').value;
          const googleFontsUrlMatches = sourceCode.match(
            /https:\/\/fonts.googleapis.com\/css\?[a-zA-Z0-9=+|&:,;]+/
          );
          if (!googleFontsUrlMatches) {
            setResultTextarea('');
            return;
          }

          const googleFontsUrl = googleFontsUrlMatches[0];
          setResultTextarea(getSnippet(googleFontsUrl));
        };

        updateResult();
        document
          .querySelector('#source-code')
          .addEventListener('input', updateResult);

        document.querySelector('#source-code').addEventListener('focus', () => {
          document.querySelector('#source-code').select();
        });

        document.querySelector('#copy-button').addEventListener('click', () => {
          document.querySelector('#result').select();
          document.execCommand('copy');
          document.querySelector('#copy-button').textContent = 'Copied';
        });
      </script>
    </div>
  </body>
</html>
